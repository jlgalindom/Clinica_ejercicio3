<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cl√≠nica Gineco-Pedi√°trica</title>
  <style>
    body { font-family: sans-serif; background-color: #fff8fa; margin: 0; padding: 1rem; }
    h1 { text-align: center; color: #c94f7c; }
    form { max-width: 600px; margin: auto; padding: 1rem; border: 1px solid #eee; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.05); background: white; }
    label { display: block; margin-top: 1rem; }
    input, select, textarea, button { width: 100%; padding: 0.5rem; margin-top: 0.5rem; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
    button { margin-top: 1rem; background-color: #c94f7c; color: white; font-weight: bold; cursor: pointer; }
    small { display: block; margin-top: 4px; font-weight: normal; color: #666; }
    .error { color: red; font-weight: bold; margin-top: 1rem; }
  </style>
</head>
<body>
  <h1>Cl√≠nica Gineco-Pedi√°trica</h1>
  <img src="https://github.com/Per-Arredondo/ejercicio_clinica.v2/blob/main/portada.png?raw=true" alt="Portada" style="display:block; margin:1rem auto; max-width:100%; border-radius:8px;">

  <form id="formulario">
    <label for="nombre">Nombre completo</label>
    <input id="nombre" name="Nombre completo" required>

    <label for="telefono">Tel√©fono</label>
    <input id="telefono" name="Tel√©fono" required>

    <label for="correo">Correo electr√≥nico</label>
    <input id="correo" name="Correo electr√≥nico" type="email" required>

    <label for="sexo">Sexo</label>
    <select id="sexo" name="Sexo" required>
      <option value="Femenino">Femenino</option>
      <option value="Masculino">Masculino</option>
      <option value="Otro">Otro</option>
    </select>

    <label for="especialidad">Especialidad</label>
    <select id="especialidad" name="Especialidad" required>
      <option value="Ginecolog√≠a">Ginecolog√≠a</option>
      <option value="Obstetricia">Obstetricia</option>
      <option value="Pediatr√≠a">Pediatr√≠a</option>
      <option value="Medicina General">Medicina General</option>
    </select>

    <label for="fecha">Fecha</label>
    <input id="fecha" name="Fecha" type="date" required
      onfocus="this.min=new Date().toISOString().split('T')[0]; this.max=new Date(Date.now()+30*24*60*60*1000).toISOString().split('T')[0];">
    <small id="diaSemanaTexto"></small>

    <label for="hora">Hora</label>
    <select id="hora" name="Hora" required>
      <option value="">Selecciona una hora...</option>
    </select>
    <small id="horaError"></small>

    <label for="comentarios">Comentarios adicionales</label>
    <textarea id="comentarios" name="Comentarios adicionales"></textarea>

    <input type="hidden" id="fechaEnvio" name="Fecha y hora de env√≠o">

    <button type="submit">Agendar cita</button>
    <button type="button" id="consultarRegistros">üß™ Consultar registros</button>
    <div id="mensajeError" class="error"></div>
  </form>

  <script>
    // Endpoint Google Apps Script
    const scriptURL = 'https://script.google.com/macros/s/AKfycby6B1XyYz0pwANd5RBzJSOqWj-UUxjl5ZGWeFfr8Ckudy48dtsJFFU_qeJTMv5VwnE/exec';

    // Funci√≥n para validar fecha: no pasadas, s√≥lo lunes a viernes
    function validarFecha() {
      const errorDiv = document.getElementById('mensajeError');
      errorDiv.textContent = '';
      const fechaEl = document.getElementById('fecha');
      const valor = fechaEl.value;
      if (!valor) return false;
      const hoy = new Date(new Date().toLocaleString('en-US',{timeZone:'America/Mexico_City'}));
      const sel = new Date(valor + 'T00:00:00-06:00');
      if (sel < new Date(hoy.toDateString())) {
        errorDiv.textContent = '‚ùå No puedes agendar citas en fechas pasadas.';
        return false;
      }
      const dia = sel.toLocaleDateString('es-MX',{weekday:'long',timeZone:'America/Mexico_City'});
      if (['s√°bado','domingo'].includes(dia)) {
        errorDiv.textContent = '‚ùå S√≥lo de lunes a viernes.';
        return false;
      }
      return true;
    }

    // Actualiza horarios disponibles
    function actualizarHorariosDisponibles() {
      const esp = document.getElementById('especialidad').value;
      const fecha = document.getElementById('fecha').value;
      const horaSel = document.getElementById('hora');
      if (!esp || !fecha) return;
      fetch(`${scriptURL}?fecha=${fecha}&especialidad=${encodeURIComponent(esp)}`)
        .then(res => res.json())
        .then(ocup => {
          // Generar intervalos de 30m entre 09:00 y 17:30
          const opciones = [];
          for (let h = 9; h < 18; h++) {
            opciones.push(`${String(h).padStart(2,'0')}:00`);
            opciones.push(`${String(h).padStart(2,'0')}:30`);
          }
          // Limpiar select
          horaSel.innerHTML = '';
          const disponibles = opciones.filter(h => !ocup.includes(h));
          if (disponibles.length === 0) {
            horaSel.innerHTML = '<option>No hay horarios disponibles</option>';
          } else {
            disponibles.forEach(h => {
              const opt = document.createElement('option');
              opt.value = h; opt.textContent = h;
              horaSel.appendChild(opt);
            });
          }
        })
        .catch(err => document.getElementById('mensajeError').textContent = '‚ùå ' + err);
    }

    // Enviar formulario
    document.getElementById('formulario').addEventListener('submit', e => {
      e.preventDefault();
      document.getElementById('mensajeError').textContent = '';
      if (!validarFecha()) return;
      const form = e.target;
      actualizarHorariosDisponibles();
      const data = new FormData(form);
      fetch(scriptURL, { method: 'POST', body: data })
        .then(r => r.text())
        .then(res => {
          if (res === 'success') {
            form.reset();
            actualizarHorariosDisponibles();
          } else if (res === 'duplicate') {
            document.getElementById('mensajeError').textContent = '‚ùå Cita duplicada.';
          } else {
            document.getElementById('mensajeError').textContent = '‚ùå ' + res;
          }
        })
        .catch(err => document.getElementById('mensajeError').textContent = '‚ùå ' + err);
    });

    // Bot√≥n para consultar registros (solo consola)
    document.getElementById('consultarRegistros').addEventListener('click', () => {
      fetch(scriptURL + '?test=all')
        .then(r => r.json())
        .then(data => console.log(data))
        .catch(err => console.error(err));
    });

    // Actualizar horarios al cambiar especialidad o fecha
    document.getElementById('especialidad').addEventListener('change', actualizarHorariosDisponibles);
    document.getElementById('fecha').addEventListener('change', actualizarHorariosDisponibles);

    // Inicializar al cargar
    window.addEventListener('DOMContentLoaded', actualizarHorariosDisponibles);
  </script>
</body>
</html>
