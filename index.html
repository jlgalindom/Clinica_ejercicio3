<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cl√≠nica Gineco-Pedi√°trica</title>
  <style>
    body { font-family: sans-serif; background-color: #fff8fa; margin: 0; padding: 1rem; }
    h1 { text-align: center; color: #c94f7c; }
    form { max-width: 600px; margin: auto; padding: 1rem; border: 1px solid #eee; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.05); background: white; }
    label { display: block; margin-top: 1rem; }
    input, select, textarea, button { width: 100%; padding: 0.5rem; margin-top: 0.5rem; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
    button { margin-top: 1rem; background-color: #c94f7c; color: white; font-weight: bold; cursor: pointer; }
    table { width: 100%; margin-top: 1rem; border-collapse: collapse; }
    th, td { padding: 8px; border: 1px solid #ccc; }
    th { background-color: #f0f0f0; }
    small { display: block; margin-top: 4px; font-weight: normal; color: #666; }
    .error { color: red; font-weight: bold; margin-top: 1rem; }
  </style>
</head>
<body>
  <h1>Cl√≠nica Gineco-Pedi√°trica</h1>
  <img src="https://github.com/Per-Arredondo/ejercicio_clinica.v2/blob/main/portada.png?raw=true" alt="Portada" style="display:block; margin:1rem auto; max-width:100%; border-radius:8px;">

  <form id="formulario">
    <label for="nombre">Nombre completo</label>
    <input id="nombre" name="Nombre completo" required>
    <label for="telefono">Tel√©fono</label>
    <input id="telefono" name="Tel√©fono" required>
    <label for="correo">Correo electr√≥nico</label>
    <input id="correo" name="Correo electr√≥nico" type="email" required>
    <label for="sexo">Sexo</label>
    <select id="sexo" name="Sexo" required>
      <option value="Femenino">Femenino</option>
      <option value="Masculino">Masculino</option>
      <option value="Otro">Otro</option>
    </select>
    <label for="especialidad">Especialidad</label>
    <select id="especialidad" name="Especialidad" required>
      <option value="Ginecolog√≠a">Ginecolog√≠a</option>
      <option value="Obstetricia">Obstetricia</option>
      <option value="Pediatr√≠a">Pediatr√≠a</option>
      <option value="Medicina General">Medicina General</option>
    </select>
    <label for="fecha">Fecha</label>
    <input id="fecha" name="Fecha" type="date" required onfocus="this.min=new Date().toISOString().split('T')[0]; this.max=new Date(Date.now()+30*24*60*60*1000).toISOString().split('T')[0];">
    <small id="diaSemanaTexto"></small>
    <label for="hora">Hora</label>
    <select id="hora" name="Hora" required>
      <option value="">Selecciona una hora...</option>
    </select>
    <small id="horaError"></small>
    <label for="comentarios">Comentarios adicionales</label>
    <textarea id="comentarios" name="Comentarios adicionales"></textarea>
    <input type="hidden" id="fechaEnvio" name="Fecha y hora de env√≠o">
    <button type="submit">Agendar cita</button>
    <button type="button" id="consultarRegistros">üß™ Consultar todos los registros</button>
    <button type="button" onclick="probarConsultaGeneral()">üß™ MiniTester: Consultar hoja</button>
    <div id="mensajeError" class="error"></div>
  </form>

  <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycby6B1XyYz0pwANd5RBzJSOqWj-UUxjl5ZGWeFfr8Ckudy48dtsJFFU_qeJTMv5VwnE/exec';

    // Valida campos de formulario y controles de fecha
    function validarFormulario(e) {
      const formError = document.getElementById('mensajeError');
      formError.textContent = '';
      const fechaEl = document.getElementById('fecha');
      const fechaVal = fechaEl.value;
      const hoy = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/Mexico_City' }));
      const sel = new Date(fechaVal + 'T00:00:00-06:00');
      if (sel < new Date(hoy.toDateString())) {
        formError.textContent = '‚ùå No puedes agendar citas en fechas pasadas.';
        fechaEl.style.borderColor = 'red'; return false;
      }
      const diaNom = sel.toLocaleDateString('es-MX',{weekday:'long',timeZone:'America/Mexico_City'});
      if (['s√°bado','domingo'].includes(diaNom)) {
        formError.textContent = '‚ùå Las citas solo se pueden agendar de lunes a viernes.';
        fechaEl.style.borderColor = 'red'; return false;
      }
      return true;
    }

    // Consulta todos los registros y los muestra en una tabla
    function probarConsultaGeneral() {
      fetch(scriptURL + '?test=all')
        .then(res => res.ok ? res.json() : Promise.reject('Error servidor'))
        .then(data => {
          const table = document.createElement('table');
          table.innerHTML = '<thead><tr>' + data[0].map(h=>`<th>${h}</th>`).join('') + '</tr></thead>';
          const tbody = document.createElement('tbody');
          data.slice(1).forEach(row => {
            const tr = document.createElement('tr');
            row.forEach((col, i) => {
              const td = document.createElement('td');
              const hdr = data[0][i];
              if (hdr==='Fecha y hora de env√≠o' && col) td.textContent = new Date(col).toLocaleString('es-MX',{timeZone:'America/Mexico_City'});
              else if (hdr==='Hora'&&col) td.textContent = col.substr(0,5);
              else td.textContent = col;
              tr.appendChild(td);
            });
            tbody.appendChild(tr);
          });
          table.appendChild(tbody);
          const ex = document.getElementById('tablaDatos'); if(ex) ex.remove();
          const div = document.createElement('div'); div.id='tablaDatos'; div.appendChild(table);
          document.getElementById('formulario').appendChild(div);
        })
        .catch(err=> document.getElementById('mensajeError').textContent = '‚ùå '+err);
    }

    // Actualiza opciones de horario excluyendo ocupados
    function actualizarHorariosDisponibles() {
      const esp = document.getElementById('especialidad').value;
      const fecha = document.getElementById('fecha').value;
      const sel = document.getElementById('hora');
      if (!esp||!fecha) return;
      fetch(`${scriptURL}?fecha=${fecha}&especialidad=${encodeURIComponent(esp)}`)
        .then(r=>r.json()).then(ocup=>{
          sel.innerHTML='';
          const opts = [];
          for(let h=9;h<=17;h++){opts.push(`${h.toString().padStart(2,'0')}:00`,`${h.toString().padStart(2,'0')}:30`);}          
          const disp = opts.filter(h=>!ocup.includes(h));
          if(!disp.length){sel.innerHTML='<option>No hay horarios disponibles</option>';}
          else disp.forEach(h=>sel.appendChild(new Option(h,h)));
        }).catch(e=>document.getElementById('mensajeError').textContent='‚ùå '+e);
    }

    document.addEventListener('DOMContentLoaded',()=>{
      actualizarHorariosDisponibles();
      document.getElementById('especialidad').addEventListener('change',()=>{ actualizarHorariosDisponibles(); });
      document.getElementById('fecha').addEventListener('change',()=>{ actualizarHorariosDisponibles(); });
      document.getElementById('consultarRegistros').addEventListener('click',probarConsultaGeneral);
      document.getElementById('formulario').addEventListener('submit',e=>{
        e.preventDefault();
        if(!validarFormulario(e)) return;
        const btn = e.target.querySelector('button[type="submit"]'); btn.disabled=true;
        const data = new FormData(e.target);
        fetch(scriptURL,{method:'POST',body:data})
          .then(r=>r.text()).then(res=>{
            btn.disabled=false;
            if(res==='success'){e.target.reset(); actualizarHorariosDisponibles();} 
            else document.getElementById('mensajeError').textContent='‚ùå '+res;
          }).catch(err=>document.getElementById('mensajeError').textContent='‚ùå '+err);
      });
    });
  </script>
</body>
</html>
