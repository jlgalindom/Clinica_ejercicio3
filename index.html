<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cl√≠nica Gineco-Pedi√°trica</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #fff8fa;
      margin: 0;
      padding: 1rem;
    }
    h1 {
      text-align: center;
      color: #c94f7c;
    }
    form {
      max-width: 600px;
      margin: auto;
      padding: 1rem;
      border: 1px solid #eee;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      background: white;
    }
    label {
      display: block;
      margin-top: 1rem;
    }
    input, select, textarea, button {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.5rem;
      border-radius: 5px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      margin-top: 1rem;
      background-color: #c94f7c;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    table {
      width: 100%;
      margin-top: 1rem;
      border-collapse: collapse;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ccc;
    }
    th {
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>
  <h1>Cl√≠nica Gineco-Pedi√°trica</h1>
  <img src="https://github.com/Per-Arredondo/ejercicio_clinica.v2/blob/main/portada.png?raw=true" alt="Portada" style="display:block; margin:1rem auto; max-width:100%; border-radius:8px;">

  <form id="formulario">
    <label for="nombre">Nombre completo</label>
    <input id="nombre" name="Nombre completo" required>
    <small id="telefonoError" style="color: red; display: block; margin-top: 4px;"></small>
    <small id="correoError" style="color: red; display: block; margin-top: 4px;"></small>
    <label for="sexo">Sexo</label>
    <select id="sexo" name="Sexo" required>
      <option value="Femenino">Femenino</option>
      <option value="Masculino">Masculino</option>
      <option value="Otro">Otro</option>
    </select>
    <label for="especialidad">Especialidad</label>
    <select id="especialidad" name="Especialidad" required>
      <option value="">Selecciona una especialidad</option>
      <option value="Ginecolog√≠a">Ginecolog√≠a</option>
      <option value="Obstetricia">Obstetricia</option>
      <option value="Pediatr√≠a">Pediatr√≠a</option>
      <option value="Medicina General">Medicina General</option>
    </select>

    <label for="fecha">Fecha</label>
    <input id="fecha" name="Fecha" type="date" required min="" onfocus="this.min=new Date().toISOString().split('T')[0]; this.max=new Date(Date.now()+30*24*60*60*1000).toISOString().split('T')[0];">
    <small id="fechaError" style="color: red; display: block; margin-top: 4px;"></small>
    $1
<small id="fechaError" style="color: red; display: block; margin-top: 4px;"></small>
    <label for="hora">Hora</label>
    <select id="hora" name="Hora" required>
      <option value="">Selecciona una hora...</option>
    </select>
    <label for="comentarios">Comentarios adicionales</label>
    <textarea id="comentarios" name="Comentarios adicionales"></textarea>
    <input type="hidden" id="fechaEnvio" name="Fecha y hora de env√≠o">
    <button type="submit">Agendar cita</button>
    <button type="button" id="consultarRegistros">üß™ Consultar todos los registros</button>
    <div id="contenedorMensajes" style="margin-top: 1rem;"></div>
    <div id="mensajeError" style="color: red; font-weight: bold; margin-top: 1rem;"></div>
  </form>

  <script>
    function validarFormulario(event) {
      const fechaSeleccionada = document.getElementById('fecha').value;
      const fechaActual = new Date();
      const diaSeleccionado = new Date(fechaSeleccionada);
      const diaSemana = diaSeleccionado.getDay();
      const maxFecha = new Date();
      maxFecha.setDate(maxFecha.getDate() + 30);
      if (diaSeleccionado < fechaActual.setHours(0,0,0,0)) {
        document.getElementById('fecha').style.borderColor = 'red';
        document.getElementById('fechaError').textContent = '‚ùå No puedes agendar citas en fechas pasadas.';
        return false;
      }
      if (diaSeleccionado > maxFecha) {
        document.getElementById('fecha').style.borderColor = 'red';
        document.getElementById('fechaError').textContent = '‚ùå Las citas solo se pueden agendar dentro de los pr√≥ximos 30 d√≠as.';
        return false;
      }
      if (diaSemana === 0 || diaSemana === 6) {
        document.getElementById('fecha').style.borderColor = 'red';
        document.getElementById('fechaError').textContent = '‚ùå Las citas solo se pueden agendar de lunes a viernes.';
        return false;
      }
      const nombre = document.getElementById('nombre').value.trim();
      const telefono = document.getElementById('telefono').value.trim();
      const correo = document.getElementById('correo').value.trim();
      const fecha = document.getElementById('fecha').value;
      const hora = document.getElementById('hora').value;

      if (!nombre || !telefono || !correo || !fecha || !hora) {
        ['nombre','telefono','correo','fecha','hora'].forEach(id => {
          const el = document.getElementById(id);
          if (!el.value.trim()) {
            el.style.borderColor = 'red';
          } else {
            el.style.borderColor = '#ccc';
          }
        });
        document.getElementById('mensajeError').textContent = 'Por favor completa todos los campos obligatorios antes de enviar.';
        event.preventDefault();
        return false;
      }
      ['nombre','telefono','correo','fecha','hora'].forEach(id => {
        document.getElementById(id).style.borderColor = '#ccc';
      });
      document.getElementById('mensajeError').textContent = '';
        document.getElementById('correoError').textContent = '';
        document.getElementById('telefonoError').textContent = '';
        document.getElementById('fechaError').textContent = '';
        ['nombre','telefono','correo','fecha','hora'].forEach(id => {
          document.getElementById(id).style.borderColor = '#ccc';
        });
      const ahora = new Date();
      const fechaEnvio = ahora.toLocaleString('sv-SE', { timeZone: 'America/Mexico_City' }).replace(',', '');
      document.getElementById('fechaEnvio').value = fechaEnvio;
      
      
      const correoValido = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(correo);
const telefonoValido = /^\d{10}$/.test(telefono);

if (!correoValido) {
  document.getElementById('correo').style.borderColor = 'red';
  document.getElementById('correoError').textContent = '‚ùå Ingresa un correo electr√≥nico v√°lido.';
  return false;
}

if (!telefonoValido) {
  document.getElementById('telefono').style.borderColor = 'red';
  document.getElementById('telefonoError').textContent = '‚ùå El tel√©fono debe tener exactamente 10 d√≠gitos num√©ricos.';
  return false;
}

      return true;
    }

    function probarConsultaGeneral() {
      const url = 'https://script.google.com/macros/s/AKfycbwODlQWO-BFuBMFvAc-RB_jBKqDmliJJ_QBFQi3zWNBgvehALHVBGJWZTg8RA7T4HQ/exec?test=all';
      fetch(url)
        .then(res => {
          if (!res.ok) throw new Error('Respuesta no v√°lida del servidor');
          return res.text();
        })
        .then(text => {
          let data;
          try {
            data = JSON.parse(text);
            if (!Array.isArray(data) || !Array.isArray(data[0])) throw new Error('Los datos recibidos no est√°n en formato de matriz esperada.');
          } catch (e) {
            throw new Error('Respuesta no es JSON v√°lido: ' + text);
          }
          const table = document.createElement('table');
          table.innerHTML = '<thead><tr>' + data[0].map(h => `<th>${h}</th>`).join('') + '</tr></thead>';
          const tbody = document.createElement('tbody');
          data.slice(1).forEach(row => {
            const tr = document.createElement('tr');
            row.forEach((col, idx) => {
              const td = document.createElement('td');
              if (data[0][idx] === 'Fecha y hora de env√≠o' && col) {
                const fecha = new Date(col);
                const anio = fecha.getFullYear();
                const mes = String(fecha.getMonth() + 1).padStart(2, '0');
                const dia = String(fecha.getDate()).padStart(2, '0');
                const horas = String(fecha.getHours()).padStart(2, '0');
                const minutos = String(fecha.getMinutes()).padStart(2, '0');
                td.textContent = `${anio}-${mes}-${dia} ${horas}:${minutos}`;
              } else {
                td.textContent = col;
              }
                td.textContent = fechaMX;
              } else {
                td.textContent = col;
              }
              tr.appendChild(td);
            });
            tbody.appendChild(tr);
          });
          table.appendChild(tbody);
          const existingPopup = document.getElementById('popupCitas');
          if (existingPopup) existingPopup.remove();
          const popup = document.createElement('div');
          popup.id = 'popupCitas';
          popup.style.position = 'fixed';
          popup.style.top = '10%';
          popup.style.left = '50%';
          popup.style.transform = 'translateX(-50%)';
          popup.style.background = 'white';
          popup.style.padding = '1rem';
          popup.style.border = '1px solid #ccc';
          popup.style.borderRadius = '8px';
          popup.style.boxShadow = '0 4px 10px rgba(0,0,0,0.2)';
          popup.style.zIndex = '1000';
          popup.style.maxHeight = '80vh';
          popup.style.overflowY = 'auto';
          const titulo = document.createElement('h2');
          titulo.textContent = 'üìã Citas registradas';
          titulo.style.marginTop = '0';
          titulo.style.textAlign = 'center';
          titulo.style.borderBottom = '1px solid #ccc';
          titulo.style.paddingBottom = '0.5rem';
          titulo.style.marginBottom = '1rem';
          popup.appendChild(titulo);
          const closeBtn = document.createElement('button');
          closeBtn.textContent = 'Cerrar';
          closeBtn.style.marginTop = '1rem';
          closeBtn.style.background = '#c94f7c';
          closeBtn.style.color = 'white';
          closeBtn.style.border = 'none';
          closeBtn.style.padding = '0.5rem 1rem';
          closeBtn.style.borderRadius = '5px';
          closeBtn.onclick = () => popup.remove();
          popup.appendChild(table);
          popup.appendChild(closeBtn);
          document.body.appendChild(popup);
        })
        .catch(err => {
          console.error('Error al obtener todos los datos:', err);
          document.getElementById('mensajeError').textContent = '‚ùå Error al obtener todos los datos: ' + err.message;
        });
    }

    function actualizarHorariosDisponibles() {
      const especialidad = document.getElementById('especialidad').value;
      const fecha = document.getElementById('fecha').value;
      const horaSelect = document.getElementById('hora');
      if (!especialidad || !fecha) return;

      const url = `https://script.google.com/macros/s/AKfycbwODlQWO-BFuBMFvAc-RB_jBKqDmliJJ_QBFQi3zWNBgvehALHVBGJWZTg8RA7T4HQ/exec?fecha=${fecha}&especialidad=${encodeURIComponent(especialidad)}`;
      fetch(url)
        .then(res => res.json())
        .then(horasOcupadas => {
          const opciones = generarOpcionesHorarios();
          horaSelect.innerHTML = '<option value="">Selecciona una hora...</option>';
          let disponibles = 0;
          opciones.forEach(hora => {
            if (!horasOcupadas.includes(hora)) {
              const option = document.createElement('option');
              option.value = hora;
              option.textContent = hora;
              horaSelect.appendChild(option);
              disponibles++;
            }
          });
          if (disponibles === 0) {
            const option = document.createElement('option');
            option.disabled = true;
            option.selected = true;
            option.textContent = 'No hay horarios disponibles';
            horaSelect.appendChild(option);
            document.querySelector('button[type="submit"]').disabled = true;
          } else {
            document.querySelector('button[type="submit"]').disabled = false;
          }
        })
        .catch(err => {
          console.error('Error al consultar horarios ocupados:', err);
          document.getElementById('mensajeError').textContent = '‚ùå Error al consultar horarios: ' + err.message;
        });
    }

    function generarOpcionesHorarios() {
      const opciones = [];
      for (let h = 9; h <= 17; h++) {
        opciones.push(`${h.toString().padStart(2, '0')}:00`);
        opciones.push(`${h.toString().padStart(2, '0')}:30`);
      }
      return opciones;
    }

    document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('formulario').addEventListener('submit', function(event) {
    event.preventDefault();
    if (!validarFormulario(event)) return;
    const form = event.target;
    const formData = new FormData(form);
    const scriptURL = 'https://script.google.com/macros/s/AKfycbwODlQWO-BFuBMFvAc-RB_jBKqDmliJJ_QBFQi3zWNBgvehALHVBGJWZTg8RA7T4HQ/exec';
    const submitButton = form.querySelector('button[type="submit"]');
    const consultaButton = document.getElementById('consultarRegistros');
    consultaButton.style.display = 'none';
    submitButton.disabled = true;
    submitButton.textContent = '‚è≥ Enviando...';
    fetch(scriptURL, { method: 'POST', body: formData })
      .then(res => res.text())
      .then(result => {
        if (result === 'success') {$1form.reset();
          const vistaPrevia = document.createElement('div');
          const fechaHora = new Date().toLocaleString('es-MX', { timeZone: 'America/Mexico_City' });
          vistaPrevia.innerHTML = `<p style='margin-top:1rem; background:#e7f1ff; color:#084298; padding:1rem; border-left:4px solid #0d6efd; border-radius:6px;'>üìã <strong>Vista previa:</strong> Cita registrada exitosamente el <strong>${fechaHora}</strong> (Hora local CDMX)</p>`;
          document.getElementById('contenedorMensajes').appendChild(vistaPrevia);
          setTimeout(() => vistaPrevia.remove(), 5000);
          console.log('‚úÖ Cita enviada correctamente y formulario limpiado.');
          actualizarHorariosDisponibles();
          
          setTimeout(() => mensaje.remove(), 5000);
          const confirmacion = document.createElement('div');
          confirmacion.innerHTML = '‚úÖ <strong>Confirmaci√≥n:</strong> los datos fueron registrados correctamente en la hoja de c√°lculo.';
          confirmacion.style.backgroundColor = '#e6f4ea';
          confirmacion.style.color = '#137333';
          confirmacion.style.padding = '1rem';
          confirmacion.style.borderRadius = '6px';
          confirmacion.style.border = '1px solid #a0d6b4';
          confirmacion.style.marginTop = '1rem';
          confirmacion.id = 'confirmacionHoja';
          document.getElementById('contenedorMensajes').appendChild(confirmacion);
          setTimeout(() => confirmacion.remove(), 5000);
          probarConsultaGeneral();
        } else if (result === 'duplicate') {
          document.getElementById('mensajeError').textContent = '‚ùå Ya existe una cita registrada para esa especialidad en ese horario.';
          submitButton.disabled = true;
          submitButton.textContent = 'Cita duplicada';
        } else {
          document.getElementById('mensajeError').textContent = '‚ùå No se pudo registrar la cita. Intenta nuevamente.';
        }
        submitButton.disabled = false;
        submitButton.textContent = 'Agendar cita';
        consultaButton.style.display = 'inline-block';
      })
      .catch(err => {
        console.error('Error al enviar formulario:', err);
        document.getElementById('mensajeError').textContent = '‚ùå Error al enviar los datos: ' + err.message;
        submitButton.disabled = false;
      });
  });
      document.getElementById('especialidad').addEventListener('change', () => {
        document.getElementById('mensajeError').textContent = '';
        document.querySelector('button[type="submit"]').disabled = false;
        document.querySelector('button[type="submit"]').textContent = 'Agendar cita';
        actualizarHorariosDisponibles();
      });
      document.getElementById('fecha').addEventListener('change', () => {
        document.getElementById('mensajeError').textContent = '';
        document.querySelector('button[type="submit"]').disabled = false;
        document.querySelector('button[type="submit"]').textContent = 'Agendar cita';
        actualizarHorariosDisponibles();
      });
      document.getElementById('hora').addEventListener('change', () => {
        document.getElementById('mensajeError').textContent = '';
        document.querySelector('button[type="submit"]').disabled = false;
        document.querySelector('button[type="submit"]').textContent = 'Agendar cita';
      });
      document.getElementById('consultarRegistros').addEventListener('click', probarConsultaGeneral);
    });
  </script>
</body>
</html>
