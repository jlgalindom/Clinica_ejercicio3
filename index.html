<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cl√≠nica Gineco-Pedi√°trica</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #fff8fa;
      margin: 0;
      padding: 1rem;
    }
    h1 {
      text-align: center;
      color: #c94f7c;
    }
    form {
      max-width: 600px;
      margin: auto;
      padding: 1rem;
      border: 1px solid #eee;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      background: white;
    }
    label {
      display: block;
      margin-top: 1rem;
    }
    input, select, textarea, button {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.5rem;
      border-radius: 5px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      margin-top: 1rem;
      background-color: #c94f7c;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    table {
      width: 100%;
      margin-top: 1rem;
      border-collapse: collapse;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ccc;
    }
    th {
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>
  <h1>Cl√≠nica Gineco-Pedi√°trica</h1>
  <form id="formulario">
    <label for="nombre">Nombre completo</label>
    <input id="nombre" name="nombre" required>

    <label for="telefono">Tel√©fono</label>
    <input id="telefono" name="telefono" required>

    <label for="correo">Correo electr√≥nico</label>
    <input id="correo" name="correo" type="email" required>

    <label for="sexo">Sexo</label>
    <select id="sexo" name="sexo" required>
      <option value="Femenino">Femenino</option>
      <option value="Masculino">Masculino</option>
      <option value="Otro">Otro</option>
    </select>

    <label for="especialidad">Especialidad</label>
    <select id="especialidad" name="especialidad" required>
      <option value="Ginecolog√≠a">Ginecolog√≠a</option>
      <option value="Obstetricia">Obstetricia</option>
      <option value="Pediatr√≠a">Pediatr√≠a</option>
      <option value="Medicina General">Medicina General</option>
    </select>

    <label for="fecha">Fecha</label>
    <input id="fecha" name="fecha" type="date" required>

    <label for="hora">Hora</label>
    <select id="hora" name="hora" required>
      <option value="">Selecciona una hora...</option>
    </select>

    <label for="comentarios">Comentarios adicionales</label>
    <textarea id="comentarios" name="comentarios"></textarea>

    <button type="submit">Agendar cita</button>
    <button type="button" onclick="probarConsultaGeneral()">üß™ Consultar todos los registros</button>
  </form>

  <script>
    function probarConsultaGeneral() {
      const url = 'https://script.google.com/macros/s/AKfycbxGcQ1_liXu1JZvrEbsFE938URX9ZB9BymilzF8UsHVSBAFtGoqJ28b8E7BFofKG4Q/exec?test=all';
      fetch(url)
        .then(res => {
          if (!res.ok) throw new Error('Respuesta no exitosa del servidor');
          return res.text();
        })
        .then(data => {
          try {
            const parsed = JSON.parse(data);
            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.innerHTML = '<thead><tr>' + parsed[0].map(h => `<th style="border:1px solid #ccc; padding:8px; background:#f0f0f0">${h}</th>`).join('') + '</tr></thead>';
            const tbody = document.createElement('tbody');
            parsed.slice(1).forEach(row => {
              const tr = document.createElement('tr');
              row.forEach(col => {
                const td = document.createElement('td');
                td.textContent = col;
                td.style.border = '1px solid #ccc';
                td.style.padding = '8px';
                tr.appendChild(td);
              });
              tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            const form = document.getElementById('formulario');
            const existing = document.getElementById('tablaDatos');
            if (existing) existing.remove();
            const wrapper = document.createElement('div');
            wrapper.id = 'tablaDatos';
            wrapper.style.marginTop = '1rem';
            wrapper.appendChild(table);
            form.appendChild(wrapper);
          } catch (error) {
            console.error('Error al procesar los datos:', error);
            alert('‚ùå Error al procesar los datos obtenidos');
          }
        })
        .catch(err => {
          console.error('Error en prueba general:', err);
          alert('‚ùå Error al obtener todos los datos');
        });
    }
  
    const especialidadInput = document.getElementById('especialidad');
    const fechaInput = document.getElementById('fecha');
    const horaSelect = document.getElementById('hora');

    especialidadInput.addEventListener('change', actualizarHorariosDisponibles);
    fechaInput.addEventListener('change', actualizarHorariosDisponibles);

    function actualizarHorariosDisponibles() {
      const especialidad = especialidadInput.value;
      const fecha = fechaInput.value;

      if (!especialidad || !fecha) return;

      const url = `https://script.google.com/macros/s/AKfycbxGcQ1_liXu1JZvrEbsFE938URX9ZB9BymilzF8UsHVSBAFtGoqJ28b8E7BFofKG4Q/exec?especialidad=${encodeURIComponent(especialidad)}&fecha=${fecha}`;

      fetch(url)
        .then(res => res.json())
        .then(ocupados => {
          const todasLasHoras = generarHorarios('09:00', '18:00', 30);
          const disponibles = todasLasHoras.filter(h => !ocupados.includes(h));

          horaSelect.innerHTML = '<option value="">Selecciona una hora...</option>';
          disponibles.forEach(h => {
            const opt = document.createElement('option');
            opt.value = opt.textContent = h;
            horaSelect.appendChild(opt);
          });

          horaSelect.disabled = disponibles.length === 0;
        })
        .catch(err => {
          console.error('Error obteniendo horarios:', err);
        });
    }

    function generarHorarios(inicio, fin, intervaloMin) {
      const resultado = [];
      const [hInicio, mInicio] = inicio.split(':').map(Number);
      const [hFin, mFin] = fin.split(':').map(Number);

      let fecha = new Date();
      fecha.setHours(hInicio, mInicio, 0);
      const limite = new Date();
      limite.setHours(hFin, mFin, 0);

      while (fecha <= limite) {
        resultado.push(fecha.toTimeString().slice(0, 5));
        fecha.setMinutes(fecha.getMinutes() + intervaloMin);
      }

      return resultado;
    }
</body>
</html>
