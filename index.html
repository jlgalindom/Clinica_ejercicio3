<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cl√≠nica Gineco-Pedi√°trica</title>
  <!-- Favicon para evitar 404 -->
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <style>
    body { font-family: sans-serif; background-color: #fff8fa; margin: 0; padding: 1rem; }
    h1 { text-align: center; color: #c94f7c; }
    form { max-width: 600px; margin: auto; padding: 1rem; border: 1px solid #eee; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.05); background: white; }
    label { display: block; margin-top: 1rem; }
    input, select, textarea, button { width: 100%; padding: 0.5rem; margin-top: 0.5rem; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
    button { margin-top: 1rem; background-color: #c94f7c; color: white; font-weight: bold; cursor: pointer; }
    small { display: block; margin-top: 4px; font-weight: normal; color: #666; }
    .error { color: red; font-weight: bold; margin-top: 1rem; }
  </style>
</head>
<body>
  <h1>Cl√≠nica Gineco-Pedi√°trica</h1>
  <img src="https://github.com/Per-Arredondo/ejercicio_clinica.v2/blob/main/portada.png?raw=true" alt="Portada" style="display:block; margin:1rem auto; max-width:100%; border-radius:8px;">

  <form id="formulario">
    <label for="nombre">Nombre completo</label>
    <input id="nombre" name="Nombre completo" required>

    <label for="telefono">Tel√©fono</label>
    <input id="telefono" name="Tel√©fono" required>

    <label for="correo">Correo electr√≥nico</label>
    <input id="correo" name="Correo electr√≥nico" type="email" required>

    <label for="sexo">Sexo</label>
    <select id="sexo" name="Sexo" required>
      <option value="Femenino">Femenino</option>
      <option value="Masculino">Masculino</option>
      <option value="Otro">Otro</option>
    </select>

    <label for="especialidad">Especialidad</label>
    <select id="especialidad" name="Especialidad" required>
      <option value="Ginecolog√≠a">Ginecolog√≠a</option>
      <option value="Obstetricia">Obstetricia</option>
      <option value="Pediatr√≠a">Pediatr√≠a</option>
      <option value="Medicina General">Medicina General</option>
    </select>

    <label for="fecha">Fecha</label>
    <input id="fecha" name="Fecha" type="date" required
      onfocus="this.min=new Date().toISOString().split('T')[0]; this.max=new Date(Date.now()+30*24*60*60*1000).toISOString().split('T')[0];">
    <small id="diaSemanaTexto"></small>

    <label for="hora">Hora</label>
    <select id="hora" name="Hora" required>
      <option value="">Selecciona una hora...</option>
    </select>
    <small id="horaError"></small>

    <label for="comentarios">Comentarios adicionales</label>
    <textarea id="comentarios" name="Comentarios adicionales"></textarea>

    <input type="hidden" id="fechaEnvio" name="Fecha y hora de env√≠o">

    <button type="submit">Agendar cita</button>
    <button type="button" id="consultarRegistros">üß™ Consultar registros</button>
    <div id="mensajeError" class="error"></div>
  </form>

  <!-- Contenedor din√°mico para mostrar la tabla -->
  <div id="tablaContainer" style="max-width: 600px; margin: 1rem auto;"></div>

  <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbzeJa77u6_1-WL6KLkAXWQR6I4E9jDb9nG11WFYWcPRutqZy5Qm-IBkR-nQV5KGsA/exec';

    function initFecha() {
      const fechaEl = document.getElementById('fecha');
      const hoy = new Date().toISOString().split('T')[0];
      fechaEl.value = hoy;
      document.getElementById('diaSemanaTexto').textContent = '';
    }

    function validarFecha() {
      const errorDiv = document.getElementById('mensajeError');
      errorDiv.textContent = '';
      const fechaEl = document.getElementById('fecha');
      const valor = fechaEl.value;
      const hoy = new Date(new Date().toLocaleString('en-US',{timeZone:'America/Mexico_City'}));
      const sel = new Date(valor + 'T00:00:00-06:00');
      if (sel < new Date(hoy.toDateString())) {
        errorDiv.textContent = '‚ùå No puedes agendar citas en fechas pasadas.';
        return false;
      }
      const dia = sel.toLocaleDateString('es-MX',{weekday:'long',timeZone:'America/Mexico_City'});
      document.getElementById('diaSemanaTexto').textContent = dia;
      if (['s√°bado','domingo'].includes(dia)) {
        errorDiv.textContent = '‚ùå S√≥lo de lunes a viernes.';
        return false;
      }
      return true;
    }

    function actualizarHorariosDisponibles() {
      const esp = document.getElementById('especialidad').value;
      const fecha = document.getElementById('fecha').value;
      const horaSel = document.getElementById('hora');
      if (!esp || !fecha) return;
      console.log('Consultando horarios para', esp, fecha);
      fetch(`${scriptURL}?fecha=${fecha}&especialidad=${encodeURIComponent(esp)}`)
        .then(res => res.json())
        .then(ocup => {
          console.log('Horarios ocupados:', ocup);
          const opciones = [];
          for (let h = 9; h < 18; h++) {
            opciones.push(`${String(h).padStart(2,'0')}:00`);
            opciones.push(`${String(h).padStart(2,'0')}:30`);
          }
          horaSel.innerHTML = '';
          const disponibles = opciones.filter(h => !ocup.includes(h));
          if (disponibles.length === 0) {
            horaSel.innerHTML = '<option>No hay horarios disponibles</option>';
          } else {
            disponibles.forEach(h => {
              const opt = document.createElement('option');
              opt.value = h; opt.textContent = h;
              horaSel.appendChild(opt);
            });
          }
        })
        .catch(err => document.getElementById('mensajeError').textContent = '‚ùå ' + err);
    }

    document.getElementById('formulario').addEventListener('submit', e => {
      e.preventDefault();
      document.getElementById('mensajeError').textContent = '';
      if (!validarFecha()) return;
      const form = e.target;
      const data = new FormData(form);
      fetch(scriptURL, { method: 'POST', body: data })
        .then(r => r.text())
        .then(res => {
          console.log('Respuesta POST:', res);
          if (res === 'success') {
            form.reset();
            initFecha();
            actualizarHorariosDisponibles();
          } else if (res === 'duplicate') {
            document.getElementById('mensajeError').textContent = '‚ùå Cita duplicada.';
          } else {
            document.getElementById('mensajeError').textContent = '‚ùå ' + res;
          }
        })
        .catch(err => document.getElementById('mensajeError').textContent = '‚ùå ' + err);
    });

    document.getElementById('consultarRegistros').addEventListener('click', () => {
      fetch(scriptURL + '?test=all')
        .then(r => r.json())
        .then(data => {
          const existing = document.getElementById('tablaRegistros');
          if (existing) existing.remove();
          const table = document.createElement('table');
          table.id = 'tablaRegistros';
          table.style.marginTop = '1rem';
          const thead = document.createElement('thead');
          const headerRow = document.createElement('tr');
          data[0].forEach(hdr => {
            const th = document.createElement('th');
            th.textContent = hdr;
            headerRow.appendChild(th);
          });
          thead.appendChild(headerRow);
          table.appendChild(thead);
          const tbody = document.createElement('tbody');
          data.slice(1).forEach(row => {
            const tr = document.createElement('tr');
            row.forEach((col, idx) => {
              const td = document.createElement('td');
              td.textContent = col;
              tr.appendChild(td);
            });
            tbody.appendChild(tr);
          });
          table.appendChild(tbody);
          document.getElementById('tablaContainer').appendChild(table);
        })
        .catch(err => {
          console.error(err);
          document.getElementById('mensajeError').textContent = '‚ùå Error al consultar registros.';
        });
    });

    window.addEventListener('DOMContentLoaded', () => {
      initFecha();
      actualizarHorariosDisponibles();
      document.getElementById('especialidad').addEventListener('change', actualizarHorariosDisponibles);
      document.getElementById('fecha').addEventListener('change', () => { initFecha(); actualizarHorariosDisponibles(); });
    });
  </script>
</body>
</html>
