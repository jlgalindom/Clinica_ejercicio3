<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cl√≠nica Gineco-Pedi√°trica</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #fff8fa;
      margin: 0;
      padding: 1rem;
    }
    h1 {
      text-align: center;
      color: #c94f7c;
    }
    form {
      max-width: 600px;
      margin: auto;
      padding: 1rem;
      border: 1px solid #eee;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      background: white;
    }
    label {
      display: block;
      margin-top: 1rem;
    }
    input, select, textarea, button {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.5rem;
      border-radius: 5px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      margin-top: 1rem;
      background-color: #c94f7c;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    table {
      width: 100%;
      margin-top: 1rem;
      border-collapse: collapse;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ccc;
    }
    th {
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>
  <h1>Cl√≠nica Gineco-Pedi√°trica</h1>
  <img src="https://github.com/Per-Arredondo/ejercicio_clinica.v2/blob/main/portada.png?raw=true" alt="Portada" style="display:block; margin:1rem auto; max-width:100%; border-radius:8px;">

  <form id="formulario">
    <label for="nombre">Nombre completo</label>
    <input id="nombre" name="Nombre completo" required>
    <label for="telefono">Tel√©fono</label>
    <input id="telefono" name="Tel√©fono" required>
    <label for="correo">Correo electr√≥nico</label>
    <input id="correo" name="Correo electr√≥nico" type="email" required>
    <label for="sexo">Sexo</label>
    <select id="sexo" name="Sexo" required>
      <option value="Femenino">Femenino</option>
      <option value="Masculino">Masculino</option>
      <option value="Otro">Otro</option>
    </select>
    
    <small id="horaError" style="color: red; display: block; margin-top: 4px;"></small>
    <label for="especialidad">Especialidad</label>
    <select id="especialidad" name="Especialidad" required>
      <option value="Ginecolog√≠a">Ginecolog√≠a</option>
      <option value="Obstetricia">Obstetricia</option>
      <option value="Pediatr√≠a">Pediatr√≠a</option>
      <option value="Medicina General">Medicina General</option>
    </select>
    <label for="fecha">Fecha</label>
    <input id="fecha" name="Fecha" type="date" required min="" onfocus="this.min=new Date().toISOString().split('T')[0]; this.max=new Date(Date.now()+30*24*60*60*1000).toISOString().split('T')[0];">
    <small id="diaSemanaTexto" style="display:block; margin-top:4px; font-weight:normal; color:#666;"></small>
    <label for="hora">Hora</label>
    <select id="hora" name="Hora" required aria-describedby="horaError">
      <option value="">Selecciona una hora...</option>
    </select>
    <label for="comentarios">Comentarios adicionales</label>
    <textarea id="comentarios" name="Comentarios adicionales"></textarea>
    <input type="hidden" id="fechaEnvio" name="Fecha y hora de env√≠o">
    <button type="submit">Agendar cita</button>
    <button type="button" id="consultarRegistros">üß™ Consultar todos los registros</button>
    <div id="mensajeError" style="color: red; font-weight: bold; margin-top: 1rem;"></div>
  </form>

  <script>
    function validarFormulario(event) {
      const fechaSeleccionada = document.getElementById('fecha').value;
      
      const diaSeleccionado = new Date(`${fechaSeleccionada}T00:00:00-06:00`);
      const ahoraCDMX = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/Mexico_City' }));
      const referenciaHoy = new Date(Date.UTC(ahoraCDMX.getFullYear(), ahoraCDMX.getMonth(), ahoraCDMX.getDate()));
      const diaSemanaNombre = new Date(`${fechaSeleccionada}T00:00:00`).toLocaleDateString('es-MX', { weekday: 'long', timeZone: 'America/Mexico_City' }).toLowerCase();
      if (diaSeleccionado < referenciaHoy) {
        document.getElementById('fecha').style.borderColor = 'red';
        document.getElementById('mensajeError').textContent = '‚ùå No puedes agendar citas en fechas pasadas.';
        return false;
      }
      if (diaSemanaNombre === 's√°bado' || diaSemanaNombre === 'domingo') {
        document.getElementById('fecha').style.borderColor = 'red';
        document.getElementById('mensajeError').textContent = '‚ùå Las citas solo se pueden agendar de lunes a viernes.';
        return false;
      }
      const nombre = document.getElementById('nombre').value.trim();
      const telefono = document.getElementById('telefono').value.trim();
      const correo = document.getElementById('correo').value.trim();
      const fecha = document.getElementById('fecha').value;
      const horaSeleccionada = document.getElementById('hora').value;

      if (!nombre || !telefono || !correo || !fecha || !hora) {
        ['nombre','telefono','correo','fecha','hora'].forEach(id => {
          const el = document.getElementById(id);
          if (!el.value.trim()) {
            el.style.borderColor = 'red';
          } else {
            el.style.borderColor = '#ccc';
          }
        });
        document.getElementById('mensajeError').textContent = 'Por favor completa todos los campos obligatorios antes de enviar.';
        event.preventDefault();
        return false;
      }
      ['nombre','telefono','correo','fecha','hora'].forEach(id => {
        document.getElementById(id).style.borderColor = '#ccc';
      });
      document.getElementById('mensajeError').textContent = '';
        ['nombre','telefono','correo','fecha','hora'].forEach(id => {
          document.getElementById(id).style.borderColor = '#ccc';
        });
      const nowCDMX = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/Mexico_City' }));
      const anio = nowCDMX.getFullYear();
      const mes = String(nowCDMX.getMonth() + 1).padStart(2, '0');
      const dia = String(nowCDMX.getDate()).padStart(2, '0');
      const horaActual = String(nowCDMX.getHours()).padStart(2, '0');
      const minutos = String(nowCDMX.getMinutes()).padStart(2, '0');
      const fechaEnvio = `${anio}-${mes}-${dia} ${horaActual}:${minutos}`;
      document.getElementById('fechaEnvio').value = fechaEnvio;
      const correoValido = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(correo);
const telefonoValido = /^\d{10}$/.test(telefono);

if (!correoValido) {
  document.getElementById('correo').style.borderColor = 'red';
  document.getElementById('mensajeError').textContent = '‚ùå Ingresa un correo electr√≥nico v√°lido.';
  return false;
}

if (!telefonoValido) {
  document.getElementById('telefono').style.borderColor = 'red';
  document.getElementById('mensajeError').textContent = '‚ùå El tel√©fono debe tener exactamente 10 d√≠gitos num√©ricos.';
  return false;
}

      return true;
    }

    function probarConsultaGeneral() {
      const url = 'https://script.google.com/macros/s/AKfycbzgyxz6HI3Tm1moZRhbQb7YZcMGm3AoEU9JstApvYf10q6e23pLNUNrS6-U-uXHJEY/exec?test=all';
      fetch(url)
        .then(res => {
          if (!res.ok) throw new Error('Respuesta no v√°lida del servidor');
          return res.text();
        })
        .then(text => {
          let data;
          try {
            data = JSON.parse(text);
            if (!Array.isArray(data) || !Array.isArray(data[0])) throw new Error('Los datos recibidos no est√°n en formato de matriz esperada.');
          } catch (e) {
            throw new Error('Respuesta no es JSON v√°lido: ' + text);
          }
          const table = document.createElement('table');
          table.innerHTML = '<thead><tr>' + data[0].map(h => `<th>${h}</th>`).join('') + '</tr></thead>';
          const tbody = document.createElement('tbody');
          data.slice(1).forEach(row => {
            const tr = document.createElement('tr');
            row.forEach((col, idx) => {
              const td = document.createElement('td');
              if (data[0][idx] === 'Fecha y hora de env√≠o' && col) {
                const fechaMX = new Date(col).toLocaleString('es-MX', { timeZone: 'America/Mexico_City' });
                td.textContent = fechaMX;
              } else {
                td.textContent = col;
              }
              tr.appendChild(td);
            });
            tbody.appendChild(tr);
          });
          table.appendChild(tbody);
          const existing = document.getElementById('tablaDatos');
          if (existing) existing.remove();
          const div = document.createElement('div');
          div.id = 'tablaDatos';
          div.appendChild(table);
          document.getElementById('formulario').appendChild(div);
        })
        .catch(err => {
          console.error('Error al obtener todos los datos:', err);
          document.getElementById('mensajeError').textContent = '‚ùå Error al obtener todos los datos: ' + err.message;
        });
    }

    function actualizarHorariosDisponibles() {
      const especialidad = document.getElementById('especialidad').value;
      const fecha = document.getElementById('fecha').value;
      const horaSelect = document.getElementById('hora');
      if (!especialidad || !fecha) return;

      const url = `https://script.google.com/macros/s/AKfycbwODlQWO-BFuBMFvAc-RB_jBKqDmliJJ_QBFQi3zWNBgvehALHVBGJWZTg8RA7T4HQ/exec?fecha=${fecha}&especialidad=${encodeURIComponent(especialidad)}`;
      console.log('URL consultada para horarios:', url);
          const visorURL = document.createElement('div');
          visorURL.textContent = url;
          visorURL.style.fontSize = '0.85rem';
          visorURL.style.background = '#f0f0f0';
          visorURL.style.padding = '0.5rem';
          visorURL.style.marginTop = '0.5rem';
          visorURL.style.border = '1px dashed #ccc';
          document.getElementById('formulario').appendChild(visorURL);
          setTimeout(() => visorURL.remove(), 6000);
      fetch(url)
        .then(res => res.json())
        .then(horasOcupadas => {
          console.log('Horarios ocupados recibidos:', horasOcupadas);
          if (!Array.isArray(horasOcupadas)) {
          alert('‚ùå No se pudo obtener horarios disponibles desde el servidor.');
          console.error('Respuesta inesperada de horarios:', horasOcupadas);
            return;
          }
          const opciones = generarOpcionesHorarios();
          const horasNormalizadas = horasOcupadas
            .map(h => {
              if (!h || typeof h !== 'string' || !h.includes(':')) return null;
              const partes = h.trim().split(':');
              if (partes.length >= 2) {
                return `${partes[0].padStart(2, '0')}:${partes[1].padStart(2, '0')}`;
              }
              return null;
            })
            .filter(Boolean);
          if (horasNormalizadas.length === 0) {
            console.warn("‚ö†Ô∏è No hay horarios v√°lidos disponibles desde el servidor.");
            document.getElementById('horaError').textContent = '‚ö†Ô∏è No se pudieron cargar horarios v√°lidos desde el servidor. Intenta cambiar la fecha o especialidad.';
          }
          horaSelect.innerHTML = '';
          const defaultOption = document.createElement('option');
          defaultOption.value = '';
          defaultOption.textContent = 'Selecciona una hora...';
          horaSelect.appendChild(defaultOption);
          document.getElementById('horaError').textContent = '';
          let disponibles = 0;
          opciones.forEach(hora => {
            if (!horasNormalizadas.includes(hora)) {
              const option = document.createElement('option');
              option.value = hora;
              option.textContent = hora;
              horaSelect.appendChild(option);
              disponibles++;
            }
          });
          if (disponibles === 0) {
            const option = document.createElement('option');
            option.disabled = true;
            option.selected = true;
            option.textContent = 'No hay horarios disponibles';
            horaSelect.appendChild(option);
            document.querySelector('button[type="submit"]').disabled = true;
          } else {
            document.querySelector('button[type="submit"]').disabled = false;
          }
        })
        .catch(err => {
          console.error('Error al consultar horarios ocupados:', err);
          document.getElementById('mensajeError').textContent = '‚ùå Error al consultar horarios: ' + err.message;
        });
    }

    function generarOpcionesHorarios() {
      const opciones = [];
      for (let h = 9; h <= 17; h++) {
        opciones.push(`${h.toString().padStart(2, '0')}:00`);
        opciones.push(`${h.toString().padStart(2, '0')}:30`);
      }
      return opciones;
    }

    document.addEventListener('DOMContentLoaded', () => {
  actualizarHorariosDisponibles();
  document.getElementById('formulario').addEventListener('submit', function(event) {
    event.preventDefault();
    if (!validarFormulario(event)) return;
    const form = event.target;
    const formData = new FormData(form);
    const scriptURL = 'https://script.google.com/macros/s/AKfycbwODlQWO-BFuBMFvAc-RB_jBKqDmliJJ_QBFQi3zWNBgvehALHVBGJWZTg8RA7T4HQ/exec';
    const submitButton = form.querySelector('button[type="submit"]');
    const consultaButton = document.getElementById('consultarRegistros');
    consultaButton.style.display = 'none';
    submitButton.disabled = true;
    submitButton.textContent = '‚è≥ Enviando...';
    fetch(scriptURL, { method: 'POST', body: formData })
      .then(res => res.text())
      .then(result => {
        if (result === 'success') {form.reset();
          document.getElementById('mensajeError').textContent = '';
          const vistaPrevia = document.createElement('div');
          const fechaHora = new Date().toLocaleString('es-MX', { timeZone: 'America/Mexico_City' });
          vistaPrevia.innerHTML = `<p style='margin-top:1rem; background:#e7f1ff; color:#084298; padding:1rem; border-left:4px solid #0d6efd; border-radius:6px;'>üìã <strong>Vista previa:</strong> Cita registrada exitosamente el <strong>${fechaHora}</strong> (Hora local CDMX)</p>`;
          form.querySelector('button[type="submit"]').after(vistaPrevia);
          console.log('‚úÖ Cita enviada correctamente y formulario limpiado.');
          actualizarHorariosDisponibles();
          
          setTimeout(() => mensaje.remove(), 5000);
          const confirmacion = document.createElement('div');
          confirmacion.textContent = '‚úÖ Confirmaci√≥n: los datos fueron registrados correctamente en la hoja de c√°lculo.';
          confirmacion.style.backgroundColor = '#e6f4ea';
          confirmacion.style.color = '#137333';
          confirmacion.style.padding = '1rem';
          confirmacion.style.borderRadius = '6px';
          confirmacion.style.border = '1px solid #a0d6b4';
          confirmacion.style.marginTop = '1rem';
          confirmacion.id = 'confirmacionHoja';
          form.querySelector('button[type="submit"]').after(confirmacion);
          setTimeout(() => confirmacion.remove(), 5000);
          probarConsultaGeneral();
        } else if (result === 'duplicate') {
          document.getElementById('mensajeError').textContent = '‚ùå Ya existe una cita registrada para esa especialidad en ese horario.';
          submitButton.disabled = true;
          submitButton.textContent = 'Cita duplicada';
        } else {
          document.getElementById('mensajeError').textContent = '‚ùå No se pudo registrar la cita. Intenta nuevamente.';
        }
        submitButton.disabled = false;
        submitButton.textContent = 'Agendar cita';
        consultaButton.style.display = 'inline-block';
      })
      .catch(err => {
        console.error('Error al enviar formulario:', err);
        document.getElementById('mensajeError').textContent = '‚ùå Error al enviar los datos: ' + err.message;
        submitButton.disabled = false;
      });
  });
      document.getElementById('especialidad').addEventListener('change', () => {
        document.getElementById('mensajeError').textContent = '';
        document.querySelector('button[type="submit"]').disabled = false;
        document.querySelector('button[type="submit"]').textContent = 'Agendar cita';
        actualizarHorariosDisponibles();
      });
      document.getElementById('fecha').addEventListener('change', () => {
        const fecha = document.getElementById('fecha').value;
        const dia = new Date(`${fecha}T00:00:00`).toLocaleDateString('es-MX', { weekday: 'long', timeZone: 'America/Mexico_City' });
        document.getElementById('diaSemanaTexto').textContent = `üìÖ D√≠a seleccionado: ${dia.charAt(0).toUpperCase() + dia.slice(1)}`;
        document.getElementById('mensajeError').textContent = '';
        document.querySelector('button[type="submit"]').disabled = false;
        document.querySelector('button[type="submit"]').textContent = 'Agendar cita';
        actualizarHorariosDisponibles();
      });
      document.getElementById('hora').addEventListener('change', () => {
        document.getElementById('mensajeError').textContent = '';
        document.querySelector('button[type="submit"]').disabled = false;
        document.querySelector('button[type="submit"]').textContent = 'Agendar cita';
      });
      document.getElementById('consultarRegistros').addEventListener('click', probarConsultaGeneral);
    });
  </script>
</body>
</html>
